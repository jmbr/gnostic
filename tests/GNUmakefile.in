###############################################################################
#
# @configure_input@
#
###############################################################################

@SET_MAKE@

SHELL := @SHELL@

srcdir := .
top_builddir := ..

VPATH := $(srcdir):$(top_builddir)

CC := @CC@

CPPFLAGS := @CPPFLAGS@
DEFS := @DEFS@
CFLAGS := @CFLAGS@
LDFLAGS := @LDFLAGS@
LIBS := @LIBS@
INCLUDES := @INCLUDES@ -I$(top_builddir)

SHTOOL := $(top_builddir)/shtool

COMPILE = $(CC) $(CPPFLAGS) $(CFLAGS) $(DEFS) $(INCLUDES)
LINK = $(CC)  $(CFLAGS) $(LDFLAGS)


###############################################################################
#
# Pattern rules.
#
###############################################################################

PROG_OBJECTS := $(filter-out $(top_builddir)/gnostic.o, \
			     $(wildcard $(top_builddir)/*.o))

.SUFFIXES: .c

%: %.c $(PROG_OBJECTS)
	@echo "Building $@"
	@$(COMPILE) -c $<
	@$(LINK) $(patsubst %.c, %.o, $<) $(PROG_OBJECTS) -o $@


###############################################################################
#
# Build rules.
#
###############################################################################

OBJECTS := $(patsubst %.c, %.o, $(wildcard test-*.c))
TEST_BINARIES := $(patsubst %.o, %, $(OBJECTS))
TEST_SCRIPTS := $(wildcard test-*.sh)
TESTS := $(sort $(TEST_BINARIES) $(TEST_SCRIPTS))

.PHONY: tests check

tests: $(TEST_BINARIES)

check: tests
	@echo "===================="
	@echo "Executing test suite"
	@echo "===================="
	@echo ""
	@for test in $(TESTS); do \
	  echo -n "Checking $$test... "; \
	  $(srcdir)/$$test 1>$$test.out 2>&1 ; \
	  RETVAL=$$?; \
	  if [ $$RETVAL -ne 0 ]; then \
	    $(SHTOOL) echo -e "%BFAILED%b"; \
            continue; \
	  fi; \
	  if [ -f $$test.exp ]; then \
	    cmp -s $$test.exp $$test.out; \
	    RETVAL=$$?; \
	    if [ $$RETVAL -ne 0 ]; then \
	      $(SHTOOL) echo -e "%BFAILED%b"; \
	      continue; \
	    fi; \
	  fi; \
	  echo "OK"; \
	done


###############################################################################
#
# Cleanup.
#
###############################################################################

.PHONY: clean clobber rmbak

clean:
	$(RM) *.o
	$(RM) *.out
	$(RM) $(TEST_BINARIES)

rmbak:
	$(RM) *~ *.bak

mostlyclean: rmbak clean ;

clobber: mostlyclean
	$(RM) config.log
	$(RM) core core.*


###############################################################################
#
# Automagick remaking of configuration files.
#
###############################################################################

GNUmakefile: GNUmakefile.in config.status
	$(SHELL) $(top_builddir)/config.status GNUmakefile
